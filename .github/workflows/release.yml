name: Release

on:
  push:
    tags:
      - 'v*.*.*'
      - 'v*.*.*-*'  # ãƒ—ãƒ¬ãƒªãƒªãƒ¼ã‚¹ï¼ˆä¾‹: v0.1.0-beta.1ï¼‰

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create Unity Package ZIP
        run: |
          TAG="${{ github.ref_name }}"
          ZIP_NAME="BOOTH-Import-Assistant-${TAG}.zip"
          
          # Assets/BoothImportAssistant/ ã‚’zipåŒ–
          # ãƒ«ãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‹ã‚‰å®Ÿè¡Œ
          cd Assets
          zip -r "../${ZIP_NAME}" BoothImportAssistant/ \
            -x "*.DS_Store" \
            -x "*.git*" \
            -x "*/node_modules/*" \
            -x "*/BoothBridge/*"
          cd ..
          
          echo "package_zip=${ZIP_NAME}" >> $GITHUB_ENV
          echo "Created: ${ZIP_NAME}"
          ls -lh "${ZIP_NAME}"

      - name: Create Browser Extension ZIP
        run: |
          TAG="${{ github.ref_name }}"
          EXT_ZIP_NAME="BOOTH-Import-Assistant-Extension-${TAG}.zip"
          
          # Extension/ ã‚’zipåŒ–
          cd Extension
          zip -r "../${EXT_ZIP_NAME}" . \
            -x "*.DS_Store" \
            -x "*.git*"
          cd ..
          
          echo "extension_zip=${EXT_ZIP_NAME}" >> $GITHUB_ENV
          echo "Created: ${EXT_ZIP_NAME}"
          ls -lh "${EXT_ZIP_NAME}"

      - name: Update VPM JSON
        run: |
          TAG="${{ github.ref_name }}"
          # vãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’å‰Šé™¤ã—ã¦ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç•ªå·ã‚’å–å¾—
          VERSION="${TAG#v}"
          VPM_JSON="docs/vpm.json"
          
          # jqãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã€ãªã‘ã‚Œã°ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          if ! command -v jq &> /dev/null; then
            sudo apt-get update && sudo apt-get install -y jq
          fi
          
          # æ—¢å­˜ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
          if jq -e ".packages.\"com.natuki.booth-import-assistant\".versions.\"${VERSION}\"" "$VPM_JSON" > /dev/null 2>&1; then
            echo "Version ${VERSION} already exists in vpm.json"
          else
            # æ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’è¿½åŠ 
            jq ".packages.\"com.natuki.booth-import-assistant\".versions.\"${VERSION}\" = \"https://github.com/natuki53/Booth-Import-Aassistant.git?path=/Assets/BoothImportAssistant\"" "$VPM_JSON" > "${VPM_JSON}.tmp" && mv "${VPM_JSON}.tmp" "$VPM_JSON"
            echo "Added version ${VERSION} to vpm.json"
          fi
          
          # æ›´æ–°å¾Œã®å†…å®¹ã‚’è¡¨ç¤º
          cat "$VPM_JSON"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            ${{ env.package_zip }}
            ${{ env.extension_zip }}
          name: ${{ github.ref_name }}
          body: ""
          draft: false
          prerelease: ${{ contains(github.ref_name, '-') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact for Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: './docs'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Output deployment URL
        run: |
          echo "ğŸš€ GitHub Pages deployed successfully!"
          echo "URL: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"


name: Release

on:
  push:
    tags:
      - 'v*.*.*'
      - 'v*.*.*-*'  # プレリリース（例: v0.1.0-beta.1）

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create Unity Package ZIP
        run: |
          TAG="${{ github.ref_name }}"
          VERSION="${TAG#v}"
          ZIP_NAME="com.natuki.booth-import-assistant-${VERSION}.zip"
          
          # Assets/BoothImportAssistant/ をzip化
          # ルートディレクトリから実行
          cd Assets
          zip -r "../${ZIP_NAME}" BoothImportAssistant/ \
            -x "*.DS_Store" \
            -x "*.git*" \
            -x "*/node_modules/*" \
            -x "*/BoothBridge/*"
          cd ..
          
          # SHA256ハッシュを計算
          if command -v sha256sum &> /dev/null; then
            ZIP_SHA256=$(sha256sum "${ZIP_NAME}" | cut -d' ' -f1)
          elif command -v shasum &> /dev/null; then
            ZIP_SHA256=$(shasum -a 256 "${ZIP_NAME}" | cut -d' ' -f1)
          else
            echo "Error: sha256sum or shasum not found"
            exit 1
          fi
          
          echo "package_zip=${ZIP_NAME}" >> $GITHUB_ENV
          echo "package_zip_sha256=${ZIP_SHA256}" >> $GITHUB_ENV
          echo "Created: ${ZIP_NAME}"
          echo "SHA256: ${ZIP_SHA256}"
          ls -lh "${ZIP_NAME}"

      - name: Create Browser Extension ZIP
        run: |
          TAG="${{ github.ref_name }}"
          EXT_ZIP_NAME="BOOTH-Import-Assistant-Extension-${TAG}.zip"
          
          # Extension/ をzip化
          cd Extension
          zip -r "../${EXT_ZIP_NAME}" . \
            -x "*.DS_Store" \
            -x "*.git*"
          cd ..
          
          echo "extension_zip=${EXT_ZIP_NAME}" >> $GITHUB_ENV
          echo "Created: ${EXT_ZIP_NAME}"
          ls -lh "${EXT_ZIP_NAME}"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            ${{ env.package_zip }}
            ${{ env.extension_zip }}
          name: ${{ github.ref_name }}
          body: ""
          draft: false
          prerelease: ${{ contains(github.ref_name, '-') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update VPM JSON
        run: |
          TAG="${{ github.ref_name }}"
          VERSION="${TAG#v}"
          VPM_JSON="docs/vpm.json"
          ZIP_NAME="${{ env.package_zip }}"
          ZIP_SHA256="${{ env.package_zip_sha256 }}"
          PACKAGE_JSON="Assets/BoothImportAssistant/package.json"
          
          # jqがインストールされているか確認し、なければインストール
          if ! command -v jq &> /dev/null; then
            sudo apt-get update && sudo apt-get install -y jq
          fi
          
          # package.jsonを読み込む
          PACKAGE_DATA=$(cat "$PACKAGE_JSON")
          
          # 既存のバージョンが存在するか確認
          if jq -e ".packages.\"com.natuki.booth-import-assistant\".versions.\"${VERSION}\"" "$VPM_JSON" > /dev/null 2>&1; then
            echo "Version ${VERSION} already exists in vpm.json"
          else
            # 新しいバージョンオブジェクトを作成
            VPM_URL="https://github.com/natuki53/Booth-Import-Aassistant/releases/download/${TAG}/${ZIP_NAME}?"
            VERSION_OBJECT=$(echo "$PACKAGE_DATA" | jq --arg url "$VPM_URL" --arg sha256 "$ZIP_SHA256" --arg repo "https://natuki53.github.io/Booth-Import-Aassistant/vpm.json" --arg changelog "https://github.com/natuki53/Booth-Import-Aassistant/releases/tag/${TAG}" '. + {
              "url": $url,
              "repo": $repo,
              "zipSHA256": $sha256,
              "changelogUrl": $changelog
            }')
            
            # vpm.jsonに追加
            jq ".packages.\"com.natuki.booth-import-assistant\".versions.\"${VERSION}\" = $VERSION_OBJECT" "$VPM_JSON" > "${VPM_JSON}.tmp" && mv "${VPM_JSON}.tmp" "$VPM_JSON"
            echo "Added version ${VERSION} to vpm.json"
          fi
          
          # 更新後の内容を表示
          cat "$VPM_JSON"

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact for Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: './docs'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Output deployment URL
        run: |
          echo "GitHub Pages deployed successfully!"
          echo "URL: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"

